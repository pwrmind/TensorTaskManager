<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Tensor Task Manager</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- –í–Ω–∏–º–∞–Ω–∏–µ: Tailwind CDN –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production. –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostCSS –∏–ª–∏ CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app" x-data="app()" x-init="init()">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button @click="sidebarCollapsed = !sidebarCollapsed" 
                        class="md:hidden text-gray-400 hover:text-white">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl md:text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-cube mr-2 text-tensor-energy"></i>
                    <span class="hidden sm:inline">TensorTask Manager</span>
                    <span class="sm:hidden">TTM</span>
                </h1>
                <div class="text-sm font-mono px-2 py-1 bg-gray-700 rounded hidden sm:block">
                    <span x-text="tfVersion"></span>
                </div>
            </div>
            
            <div class="flex space-x-1 md:space-x-2 flex-wrap gap-2">
                <button @click="viewMode = '3d'" 
                        :class="viewMode === '3d' ? 'bg-blue-600' : 'bg-gray-700'"
                        class="px-2 md:px-4 py-2 rounded-lg flex items-center text-sm">
                    <i class="fas fa-cube mr-1 md:mr-2"></i> 
                    <span class="hidden md:inline">3D –≤–∏–¥</span>
                </button>
                <button @click="viewMode = 'list'" 
                        :class="viewMode === 'list' ? 'bg-blue-600' : 'bg-gray-700'"
                        class="px-2 md:px-4 py-2 rounded-lg flex items-center text-sm">
                    <i class="fas fa-list mr-1 md:mr-2"></i> 
                    <span class="hidden md:inline">–°–ø–∏—Å–æ–∫</span>
                </button>
                <button @click="batchSimilarTasks()" 
                        class="px-2 md:px-4 py-2 bg-purple-600 rounded-lg flex items-center hover:bg-purple-700 text-sm">
                    <i class="fas fa-layer-group mr-1 md:mr-2"></i> 
                    <span class="hidden md:inline">–ë–∞—Ç—á–∏–Ω–≥</span>
                </button>
                <div class="relative">
                    <button @click="showExportMenu = !showExportMenu" 
                            class="px-2 md:px-4 py-2 bg-green-600 rounded-lg flex items-center hover:bg-green-700 text-sm">
                        <i class="fas fa-download mr-1 md:mr-2"></i> 
                        <span class="hidden md:inline">–≠–∫—Å–ø–æ—Ä—Ç</span>
                        <i class="fas fa-chevron-down ml-1 text-xs"></i>
                    </button>
                    <div x-show="showExportMenu" 
                         @click.away="showExportMenu = false"
                         x-transition
                         class="absolute right-0 mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 min-w-[200px]">
                        <button @click="exportData('json'); showExportMenu = false" 
                                class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                            <i class="fas fa-file-code mr-2"></i> JSON
                        </button>
                        <button @click="exportData('csv'); showExportMenu = false" 
                                class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                            <i class="fas fa-file-csv mr-2"></i> CSV
                        </button>
                        <button @click="exportData('ical'); showExportMenu = false" 
                                class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                            <i class="fas fa-calendar mr-2"></i> iCal
                        </button>
                        <button @click="exportData('markdown'); showExportMenu = false" 
                                class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                            <i class="fas fa-file-alt mr-2"></i> Markdown
                        </button>
                    </div>
                </div>
                <button @click="showImportDialog = true" 
                        class="px-2 md:px-4 py-2 bg-indigo-600 rounded-lg flex items-center hover:bg-indigo-700 text-sm">
                    <i class="fas fa-upload mr-1 md:mr-2"></i> 
                    <span class="hidden md:inline">–ò–º–ø–æ—Ä—Ç</span>
                </button>
            </div>
        </nav>
        
        <div class="flex h-screen">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <!-- Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
            <div class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40" 
                 x-show="!sidebarCollapsed && windowWidth <= 768"
                 @click="sidebarCollapsed = true"
                 x-transition></div>
            <!-- –°–∞–º–∞ –ø–∞–Ω–µ–ª—å -->
            <div :class="'bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto transition-all duration-300 ' + 
                         (sidebarCollapsed ? 'w-0 p-0 overflow-hidden -translate-x-full md:translate-x-0' : 'w-80 translate-x-0')"
                 class="fixed md:relative inset-y-0 left-0 z-50 md:z-auto">
                <button @click="sidebarCollapsed = !sidebarCollapsed" 
                        class="md:hidden absolute top-2 right-2 text-gray-400 hover:text-white z-10">
                    <i class="fas fa-times"></i>
                </button>
                <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-user-circle mr-2"></i> –ú–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    </h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm mb-1">üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                            <select x-model="userContext.location" @change="applyContextSlicing(userContext)"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                                <option value="home">üè† –î–æ–º–∞</option>
                                <option value="office">üè¢ –í –æ—Ñ–∏—Å–µ</option>
                                <option value="mobile">üöó –í –¥–æ—Ä–æ–≥–µ</option>
                                <option value="any">üåê –õ—é–±–æ–µ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm mb-1">
                                ‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span x-text="Math.round(userContext.energy * 100)"></span>%
                            </label>
                            <input type="range" x-model="userContext.energy" min="0" max="1" step="0.1"
                                   @input="applyContextSlicing(userContext)"
                                   class="w-full accent-tensor-energy">
                        </div>
                        
                        <div>
                            <label class="block text-sm mb-1">
                                ‚è±Ô∏è –í—Ä–µ–º—è: <span x-text="userContext.availableTime"></span> –º–∏–Ω
                            </label>
                            <input type="range" x-model="userContext.availableTime" min="5" max="240" step="5"
                                   @input="applyContextSlicing(userContext)"
                                   class="w-full accent-tensor-time">
                        </div>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-filter mr-2"></i> –¢–µ–Ω–∑–æ—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">üîã –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è</label>
                            <input type="range" x-model="currentMask.energy" min="0" max="1" step="0.1"
                                   @input="applyFilters()"
                                   class="w-full accent-tensor-energy">
                            <div class="text-xs text-gray-400" x-text="(currentMask.energy * 100).toFixed(0) + '%'"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm mb-1">üéØ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</label>
                            <input type="range" x-model="currentMask.value" min="0" max="1" step="0.1"
                                   @input="applyFilters()"
                                   class="w-full accent-tensor-value">
                            <div class="text-xs text-gray-400" x-text="(currentMask.value * 100).toFixed(0) + '%'"></div>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-search mr-2"></i> –ü–æ–∏—Å–∫
                    </h3>
                    <input type="text" x-model="searchQuery" @input="applyFilters()"
                           placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..."
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-2">
                    <div>
                        <label class="block text-sm mb-1">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                        <select x-model="sortBy" @change="applyFilters()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
                            <option value="urgency">–ü–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏</option>
                            <option value="value">–ü–æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏</option>
                            <option value="energy">–ü–æ —ç–Ω–µ—Ä–≥–∏–∏</option>
                            <option value="duration">–ü–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</option>
                            <option value="created">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                        </select>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="mt-6 p-3 bg-gray-700 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                        <button @click="showStatsTab = !showStatsTab" 
                                class="text-xs text-gray-400 hover:text-white">
                            <i :class="showStatsTab ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                        </button>
                    </div>
                    <div class="text-sm space-y-1">
                        <div>–í—Å–µ–≥–æ –∑–∞–¥–∞—á: <span x-text="tasks.length"></span></div>
                        <div>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span x-text="completedTasksCount"></span> (<span x-text="completionPercentage"></span>%)</div>
                        <div>–í–∏–¥–∏–º—ã—Ö: <span x-text="visibleTasks.length"></span></div>
                        <div>–ö–ª–∞—Å—Ç–µ—Ä–æ–≤: <span x-text="Object.keys(activeFilters.clusters || {}).length"></span></div>
                        <div>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö: <span x-text="highPriorityTasksCount"></span></div>
                        <template x-if="probabilisticStats">
                            <div>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <span x-text="(probabilisticStats.confidence * 100).toFixed(1)"></span>%</div>
                        </template>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                    <template x-if="showStatsTab">
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º -->
                            <div class="mb-4">
                                <h5 class="text-xs font-semibold mb-2 text-gray-400">–ü–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º</h5>
                                <div class="space-y-1">
                                    <template x-for="(label, key) in CONTEXT_LABELS" :key="key">
                                        <div class="flex items-center justify-between text-xs">
                                            <span x-text="label.label"></span>
                                            <span class="text-gray-300">
                                                <span x-text="tasks.filter(t => t.context === key).length"></span>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
                            <div class="mb-4">
                                <h5 class="text-xs font-semibold mb-2 text-gray-400">–ü–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h5>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center justify-between">
                                        <span>–ö–æ—Ä–æ—Ç–∫–∏–µ (&lt;30 –º–∏–Ω)</span>
                                        <span class="text-gray-300" x-text="tasks.filter(t => t.tensor[4] < 30).length"></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>–°—Ä–µ–¥–Ω–∏–µ (30-120 –º–∏–Ω)</span>
                                        <span class="text-gray-300" x-text="tasks.filter(t => t.tensor[4] >= 30 && t.tensor[4] < 120).length"></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>–î–ª–∏–Ω–Ω—ã–µ (&gt;120 –º–∏–Ω)</span>
                                        <span class="text-gray-300" x-text="tasks.filter(t => t.tensor[4] >= 120).length"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –î–µ–¥–ª–∞–π–Ω—ã -->
                            <template x-if="tasks.some(t => t.deadline)">
                                <div>
                                    <h5 class="text-xs font-semibold mb-2 text-gray-400">–î–µ–¥–ª–∞–π–Ω—ã</h5>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex items-center justify-between">
                                            <span class="text-red-400">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                            <span class="text-gray-300" x-text="tasks.filter(t => t.deadline && getDeadlineStatus(t)?.status === 'overdue').length"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-orange-400">–°–µ–≥–æ–¥–Ω—è</span>
                                            <span class="text-gray-300" x-text="tasks.filter(t => t.deadline && getDeadlineStatus(t)?.status === 'today').length"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-yellow-400">–°–∫–æ—Ä–æ</span>
                                            <span class="text-gray-300" x-text="tasks.filter(t => t.deadline && getDeadlineStatus(t)?.status === 'soon').length"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
            <div class="flex-1 flex flex-col">
                <!-- 3D Canvas –∏–ª–∏ —Å–ø–∏—Å–æ–∫ -->
                <div class="flex-1 relative">
                    <template x-if="viewMode === '3d'">
                        <div id="three-container" class="w-full h-full relative">
                            <div class="absolute top-4 left-4 bg-gray-800 bg-opacity-90 p-3 rounded-lg z-10 text-xs">
                                <div class="space-y-1">
                                    <div><i class="fas fa-mouse mr-2"></i>–õ–ö–ú: –í—ã–±—Ä–∞—Ç—å –∑–∞–¥–∞—á—É</div>
                                    <div><i class="fas fa-arrows-alt mr-2"></i>Ctrl+–õ–ö–ú –∏–ª–∏ –ü–ö–ú: –í—Ä–∞—â–∞—Ç—å –∫–∞–º–µ—Ä—É</div>
                                    <div><i class="fas fa-search-plus mr-2"></i>–ö–æ–ª–µ—Å–æ –º—ã—à–∏: –ú–∞—Å—à—Ç–∞–±</div>
                                    <div class="text-gray-400 mt-2 pt-2 border-t border-gray-600">
                                        <div>‚ö° X: –≠–Ω–µ—Ä–≥–∏—è</div>
                                        <div>üìç Y: –ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
                                        <div>üéØ Z: –¶–µ–Ω–Ω–æ—Å—Ç—å</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="viewMode === 'list'">
                        <div class="p-6 overflow-y-auto h-full">
                            <div class="mb-6 flex justify-between items-center">
                                <h2 class="text-xl font-bold">–ó–∞–¥–∞—á–∏ (<span x-text="visibleTasks.length"></span>)</h2>
                                <div class="flex space-x-2">
                                    <button @click="autoPrioritize()"
                                            class="px-4 py-2 bg-yellow-600 rounded-lg flex items-center hover:bg-yellow-700"
                                            title="Ctrl+P">
                                        <i class="fas fa-star mr-2"></i> –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è
                                    </button>
                                    <div class="relative">
                                        <button @click="showTemplatesMenu = !showTemplatesMenu"
                                                class="px-4 py-2 bg-blue-600 rounded-lg flex items-center hover:bg-blue-700">
                                            <i class="fas fa-file-alt mr-2"></i> –®–∞–±–ª–æ–Ω—ã
                                            <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                        </button>
                                        <div x-show="showTemplatesMenu" 
                                             @click.away="showTemplatesMenu = false"
                                             x-transition
                                             class="absolute right-0 mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 min-w-[200px]">
                                            <template x-if="taskTemplates.length === 0">
                                                <div class="px-4 py-2 text-gray-400 text-sm">–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</div>
                                            </template>
                                            <template x-for="(template, index) in taskTemplates" :key="index">
                                                <button @click="createTask(template); showTemplatesMenu = false" 
                                                        class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center justify-between">
                                                    <span x-text="template.title"></span>
                                                    <i class="fas fa-plus text-xs"></i>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                    <button @click="createTask()"
                                            class="px-4 py-2 bg-green-600 rounded-lg flex items-center hover:bg-green-700"
                                            title="Ctrl+N">
                                        <i class="fas fa-plus mr-2"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                                    </button>
                                </div>
                            </div>
                            
                            <!-- –ë–∞—Ç—á–∏ -->
                            <template x-if="activeFilters.batches && activeFilters.batches.length > 0">
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold mb-3">üì¶ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∞—Ç—á–∏</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <template x-for="(batch, index) in activeFilters.batches" :key="index">
                                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 hover:border-purple-500 transition-colors">
                                                <div class="font-semibold mb-2 flex items-center justify-between">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-layer-group mr-2 text-purple-400"></i>
                                                        –ë–∞—Ç—á <span x-text="index + 1"></span>
                                                        <span class="ml-2 text-xs text-gray-400">(<span x-text="batch.taskCount || batch.taskIds.length"></span> –∑–∞–¥–∞—á)</span>
                                                    </div>
                                                    <button @click="executeBatch(index)"
                                                            class="px-2 py-1 bg-green-600 rounded text-xs hover:bg-green-700">
                                                        <i class="fas fa-check mr-1"></i>–í—ã–ø–æ–ª–Ω–∏—Ç—å
                                                    </button>
                                                </div>
                                                <div class="text-sm text-gray-300 space-y-1 mb-2">
                                                    <template x-for="taskId in (batch.taskIds || batch)" :key="taskId">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-circle text-xs mr-2 text-purple-400"></i>
                                                            <span x-text="getTaskTitle(taskId)"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                                <template x-if="batch.totalDuration !== undefined">
                                                    <div class="mt-2 pt-2 border-t border-gray-700 text-xs space-y-1">
                                                        <div class="flex justify-between">
                                                            <span class="text-gray-400">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                                                            <span class="text-white"><span x-text="batch.totalDuration"></span> –º–∏–Ω</span>
                                                        </div>
                                                        <template x-if="batch.timeSaved > 0">
                                                            <div class="flex justify-between text-green-400">
                                                                <span>–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏:</span>
                                                                <span><span x-text="batch.timeSaved"></span> –º–∏–Ω</span>
                                                            </div>
                                                        </template>
                                                        <template x-if="batch.similarity !== undefined">
                                                            <div class="flex justify-between">
                                                                <span class="text-gray-400">–ü–æ—Ö–æ–∂–µ—Å—Ç—å:</span>
                                                                <span class="text-white"><span x-text="Math.round(batch.similarity * 100)"></span>%</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
                            <div class="space-y-3">
                                <template x-for="task in sortedAndFilteredTasks" :key="task.id">
                                    <div :class="selectedTaskId === task.id ? 'ring-2 ring-blue-500' : ''"
                                         @click="selectedTaskId = task.id"
                                         class="bg-gray-800 border border-gray-700 rounded-lg p-4 hover:bg-gray-750 cursor-pointer transition-all"
                                         :class="task.completed ? 'opacity-60' : ''">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 flex-wrap">
                                                    <h4 class="font-semibold text-lg" x-text="task.title"></h4>
                                                    <template x-if="task.priority">
                                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-600">
                                                            <i class="fas fa-star mr-1"></i>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                                                        </span>
                                                    </template>
                                                    <template x-if="task.completed">
                                                        <span class="px-2 py-1 text-xs rounded-full bg-green-600">
                                                            <i class="fas fa-check mr-1"></i>–í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                                        </span>
                                                    </template>
                                                    <template x-if="task.deadline">
                                                        <span :class="'px-2 py-1 text-xs rounded-full ' + 
                                                            (getDeadlineStatus(task)?.status === 'overdue' ? 'bg-red-600' : 
                                                             getDeadlineStatus(task)?.status === 'today' ? 'bg-orange-600' :
                                                             getDeadlineStatus(task)?.status === 'soon' ? 'bg-yellow-600' : 'bg-blue-600')">
                                                            <i class="fas fa-calendar mr-1"></i>
                                                            <span x-text="formatDeadline(task.deadline)"></span>
                                                            <template x-if="getDeadlineStatus(task)?.status === 'overdue'">
                                                                <span class="ml-1">(–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)</span>
                                                            </template>
                                                        </span>
                                                    </template>
                                                </div>
                                                <p class="text-gray-400 text-sm mt-1" x-text="task.description"></p>
                                                <div class="text-xs text-gray-500 mt-1">
                                                    <span x-text="formatDate(task.createdAt)"></span>
                                                    <template x-if="task.completedAt">
                                                        <span class="ml-2 text-green-400">
                                                            –í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span x-text="formatDate(task.completedAt)"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="px-2 py-1 text-xs rounded-full"
                                                      :style="'background-color: ' + (CONTEXT_LABELS[task.context]?.color || '#8A8D8F')">
                                                    <span x-text="CONTEXT_LABELS[task.context]?.label || '–õ—é–±–æ–π'"></span>
                                                </span>
                                                <button @click.stop="deleteTask(task.id)"
                                                        class="text-red-400 hover:text-red-300">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- –¢–µ–Ω–∑–æ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -->
                                        <div class="mt-3 grid grid-cols-4 gap-2">
                                            <div class="text-center">
                                                <div class="text-xs text-gray-400">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
                                                <input type="range" min="0" max="1" step="0.1"
                                                       :value="task.tensor[0]"
                                                       @input="updateTaskTensor(task.id, 0, $event.target.value)"
                                                       class="w-full accent-tensor-energy">
                                                <div class="text-xs" x-text="Math.round(task.tensor[0] * 100) + '%'"></div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <div class="text-xs text-gray-400">üéØ –¶–µ–Ω–Ω–æ—Å—Ç—å</div>
                                                <input type="range" min="0" max="1" step="0.1"
                                                       :value="task.tensor[2]"
                                                       @input="updateTaskTensor(task.id, 2, $event.target.value)"
                                                       class="w-full accent-tensor-value">
                                                <div class="text-xs" x-text="Math.round(task.tensor[2] * 100) + '%'"></div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <div class="text-xs text-gray-400">‚è±Ô∏è –°—Ä–æ—á–Ω–æ—Å—Ç—å</div>
                                                <input type="range" min="0" max="1" step="0.1"
                                                       :value="task.tensor[3]"
                                                       @input="updateTaskTensor(task.id, 3, $event.target.value)"
                                                       class="w-full accent-tensor-time">
                                                <div class="text-xs" x-text="Math.round(task.tensor[3] * 100) + '%'"></div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <div class="text-xs text-gray-400">‚åõ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                                                <div class="text-sm" x-text="task.tensor[4] + ' –º–∏–Ω'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
                <template x-if="selectedTask">
                    <div class="border-t border-gray-700 bg-gray-800 p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">
                                <span x-text="selectedTask.title === '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞' && !selectedTask.description ? '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'"></span>
                            </h3>
                            <div class="flex space-x-2">
                                <button @click="probabilisticPlanning()"
                                        class="px-3 py-1 bg-purple-600 rounded text-sm">
                                    <i class="fas fa-chart-line mr-1"></i> –ê–Ω–∞–ª–∏–∑
                                </button>
                                <button @click="duplicateTask(selectedTask.id)"
                                        class="px-3 py-1 bg-blue-600 rounded text-sm">
                                    <i class="fas fa-copy mr-1"></i> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button @click="saveAsTemplate(selectedTask.id)"
                                        class="px-3 py-1 bg-indigo-600 rounded text-sm">
                                    <i class="fas fa-save mr-1"></i> –®–∞–±–ª–æ–Ω
                                </button>
                                <button @click="selectedTask.completed = !selectedTask.completed"
                                        :class="selectedTask.completed ? 'bg-green-600' : 'bg-gray-600'"
                                        class="px-3 py-1 rounded text-sm">
                                    <i class="fas fa-check mr-1"></i>
                                    <span x-text="selectedTask.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å'"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <input type="text" x-model="selectedTask.title"
                                       class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            </div>
                            
                            <div>
                                <label class="block text-sm mb-1">–ö–æ–Ω—Ç–µ–∫—Å—Ç</label>
                                <select x-model="selectedTask.context"
                                        @change="updateTaskTensor(selectedTask.id, 1, ['home','office','mobile','any'].indexOf($event.target.value))"
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                                    <option value="home">üè† –î–æ–º–∞</option>
                                    <option value="office">üè¢ –û—Ñ–∏—Å</option>
                                    <option value="mobile">üöó –ú–æ–±–∏–ª—å–Ω—ã–π</option>
                                    <option value="any">üåê –õ—é–±–æ–π</option>
                                </select>
                            </div>
                            
                            <div class="col-span-2">
                                <label class="block text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea x-model="selectedTask.description" rows="3"
                                          class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm mb-1">–î–µ–¥–ª–∞–π–Ω</label>
                                <input type="datetime-local" 
                                       :value="selectedTask.deadline ? new Date(selectedTask.deadline).toISOString().slice(0, 16) : ''"
                                       @input="selectedTask.deadline = $event.target.value ? new Date($event.target.value) : null"
                                       class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            </div>
                            
                            <div>
                                <label class="block text-sm mb-1">
                                    <input type="checkbox" x-model="selectedTask.deadline" 
                                           @change="selectedTask.deadline = $event.target.checked ? new Date(Date.now() + 86400000) : null"
                                           class="mr-2">
                                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞
                                </label>
                            </div>
                        </div>
                        
                        <!-- –¢–µ–Ω–∑–æ—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">–¢–µ–Ω–∑–æ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</h4>
                            <div class="grid grid-cols-5 gap-3">
                                <template x-for="(axis, index) in ['–≠–Ω–µ—Ä–≥–∏—è', '–ö–æ–Ω—Ç–µ–∫—Å—Ç', '–¶–µ–Ω–Ω–æ—Å—Ç—å', '–°—Ä–æ—á–Ω–æ—Å—Ç—å', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å']" :key="index">
                                    <div class="text-center">
                                        <div class="text-sm mb-1" x-text="axis"></div>
                                        <input type="range" :min="index === 4 ? 5 : 0" 
                                               :max="index === 4 ? 480 : 1" 
                                               :step="index === 4 ? 5 : 0.1"
                                               :value="selectedTask.tensor[index]"
                                               @input="updateTaskTensor(selectedTask.id, index, parseFloat($event.target.value))"
                                               :class="'accent-tensor-' + ['energy','context','value','time','duration'][index]"
                                               class="w-full">
                                        <div class="text-xs mt-1">
                                            <span x-text="index === 4 ? selectedTask.tensor[index] + ' –º–∏–Ω' : Math.round(selectedTask.tensor[index] * 100) + '%'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="mt-6 flex justify-between items-center pt-4 border-t border-gray-700">
                            <div class="flex space-x-2">
                                <button @click="saveTask()"
                                        class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 flex items-center">
                                    <i class="fas fa-save mr-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                                <button @click="selectedTaskId = null"
                                        class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 flex items-center">
                                    <i class="fas fa-times mr-2"></i> –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                            <button @click="deleteTask(selectedTask.id)"
                                    class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 flex items-center">
                                <i class="fas fa-trash mr-2"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <template x-if="isLoading">
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-center mb-4">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    </div>
                    <div class="text-center mb-2">
                        <p class="text-white">–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                    <template x-if="loadingProgress > 0">
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                 :style="'width: ' + loadingProgress + '%'"></div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        
        <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="fixed bottom-4 right-4 space-y-2 z-50">
            <template x-for="(toast, index) in toasts" :key="index">
                <div :class="'bg-' + toast.type + '-600 text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in flex items-center justify-between min-w-[300px]'"
                     x-show="toast.visible"
                     x-transition>
                    <div class="flex items-center">
                        <i :class="toast.icon + ' mr-2'"></i>
                        <span x-text="toast.message"></span>
                    </div>
                    <button @click="removeToast(index)" class="ml-4 hover:opacity-70">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </template>
        </div>
        
        <!-- –î–∏–∞–ª–æ–≥ –∏–º–ø–æ—Ä—Ç–∞ -->
        <template x-if="showImportDialog">
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showImportDialog = false">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á</h3>
                    <textarea x-model="importData" rows="10" 
                              placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON –¥–∞–Ω–Ω—ã–µ..."
                              class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-4 font-mono text-sm"></textarea>
                    <div class="flex space-x-2">
                        <button @click="importDataFromJSON()" 
                                class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 flex-1">
                            <i class="fas fa-upload mr-2"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button @click="showImportDialog = false" 
                                class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind CSS
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tensor: {
                            energy: '#FF6B6B',
                            context: '#4ECDC4',
                            value: '#FFD166',
                            time: '#06D6A0',
                            strategy: '#118AB2'
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s ease-in-out infinite',
                        'fade-in': 'fade-in 0.3s ease-out'
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 0.5 },
                            '50%': { opacity: 1 }
                        },
                        'fade-in': {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        }
                    }
                }
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const TENSOR_AXES = {
            ENERGY: { id: 'energy', label: '‚ö° –≠–Ω–µ—Ä–≥–∏—è', min: 0, max: 1, step: 0.1 },
            CONTEXT: { id: 'context', label: 'üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç', type: 'categorical', values: ['home', 'office', 'mobile', 'any'] },
            VALUE: { id: 'value', label: 'üéØ –¶–µ–Ω–Ω–æ—Å—Ç—å', min: 0, max: 1, step: 0.1 },
            TIME: { id: 'time', label: '‚è±Ô∏è –°—Ä–æ—á–Ω–æ—Å—Ç—å', min: 0, max: 1, step: 0.1 },
            DURATION: { id: 'duration', label: '‚åõ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', min: 5, max: 480, step: 5 }
        };

        const CONTEXT_LABELS = {
            home: { label: 'üè† –î–æ–º', color: '#4ECDC4' },
            office: { label: 'üè¢ –û—Ñ–∏—Å', color: '#118AB2' },
            mobile: { label: 'üöó –ú–æ–±–∏–ª—å–Ω—ã–π', color: '#FFD166' },
            any: { label: 'üåê –õ—é–±–æ–π', color: '#8A8D8F' }
        };

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è Three.js –æ–±—ä–µ–∫—Ç–æ–≤ (–≤–Ω–µ Alpine.js –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –ø—Ä–æ–∫—Å–∏)
        const threeJSStore = {
            scene: null,
            camera: null,
            renderer: null,
            taskPoints: null,
            container: null,
            taskObjectsMap: new Map(), // –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ taskId –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            objectPool: [], // –ü—É–ª –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            isAnimating: true // –§–ª–∞–≥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–µ–π
        };

        // –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function app() {
            return {
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ
                tasks: [],
                currentMask: null,
                activeFilters: {},
                viewMode: '3d',
                selectedTaskId: null,
                userContext: {
                    location: 'any',
                    energy: 0.7,
                    availableTime: 30
                },
                probabilisticStats: null,
                tfVersion: tf.version.tfjs,
                // Three.js –æ–±—ä–µ–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ threeJSStore (–≤–Ω–µ Alpine.js)
                searchQuery: '',
                sortBy: 'priority',
                toasts: [],
                showImportDialog: false,
                importData: '',
                isDragging: false,
                mouseX: 0,
                mouseY: 0,
                filterDebounceTimer: null,
                isApplyingFilters: false,
                isLoading: false,
                loadingProgress: 0,
                taskTemplates: [],
                showKeyboardShortcuts: false,
                sidebarCollapsed: false,
                showExportMenu: false,
                showTemplatesMenu: false,
                showStatsTab: false,
                windowWidth: typeof window !== 'undefined' ? window.innerWidth : 1024,
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                async init() {
                    this.loadFromStorage();
                    if (this.tasks.length === 0) {
                        await this.loadSampleData();
                    }
                    if (!this.currentMask) {
                        this.initializeDefaultMask();
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (!this.activeFilters.filteredTasks) {
                        this.activeFilters.filteredTasks = this.tasks.map(t => t.id);
                    }
                    
                    // –£–±—Ä–∞–ª–∏ watch –Ω–∞ activeFilters —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                    this.$watch('visibleTasks', () => this.updateTaskVisualization());
                    this.$watch('selectedTaskId', () => this.updateTaskVisualization());
                    this.$watch('tasks', () => {
                        this.saveToStorage();
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á, –Ω–æ —Å debounce
                        if (this.filterDebounceTimer) {
                            clearTimeout(this.filterDebounceTimer);
                        }
                        this.filterDebounceTimer = setTimeout(() => this.applyFilters(), 200);
                    });
                    this.$watch('userContext', () => this.saveToStorage());
                    this.$watch('viewMode', (newMode) => {
                        this.saveToStorage();
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ 3D –≤–∏–¥
                        if (newMode === '3d' && !threeJSStore.scene) {
                            // –ñ–¥–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM —á–µ—Ä–µ–∑ setTimeout
                            setTimeout(async () => {
                                await this.initThreeJS();
                            }, 100);
                        }
                    });
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js –µ—Å–ª–∏ —É–∂–µ –≤ 3D —Ä–µ–∂–∏–º–µ
                    if (this.viewMode === '3d') {
                        // –ñ–¥–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM —á–µ—Ä–µ–∑ setTimeout
                        setTimeout(async () => {
                            await this.initThreeJS();
                        }, 200);
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    setTimeout(() => this.applyFilters(), 100);
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
                    this.setupKeyboardShortcuts();
                    
                    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    if (typeof window !== 'undefined') {
                        window.addEventListener('resize', () => {
                            this.windowWidth = window.innerWidth;
                            if (this.windowWidth > 768 && this.sidebarCollapsed) {
                                this.sidebarCollapsed = false;
                            }
                        });
                        this.windowWidth = window.innerWidth;
                    }
                },
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                loadSampleData() {
                    this.tasks = [
                        {
                            id: '1',
                            title: '–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É',
                            description: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ö–æ–¥–µ —Ä–∞–±–æ—Ç',
                            tensor: [0.8, 1, 0.9, 0.7, 120],
                            context: 'office',
                            createdAt: new Date(),
                            completed: false,
                            priority: false,
                            deadline: null,
                            completedAt: null
                        },
                        {
                            id: '2',
                            title: '–ó–∞–∫–∞–∑–∞—Ç—å –≤–æ–¥—É',
                            description: '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º',
                            tensor: [0.2, 0, 0.2, 0.3, 5],
                            context: 'home',
                            createdAt: new Date(),
                            completed: false,
                            priority: false,
                            deadline: null,
                            completedAt: null
                        },
                        {
                            id: '3',
                            title: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É',
                            description: '–û–±—Å—É–¥–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä',
                            tensor: [0.5, 2, 0.6, 0.8, 15],
                            context: 'mobile',
                            createdAt: new Date(),
                            completed: false,
                            priority: false,
                            deadline: null,
                            completedAt: null
                        },
                        {
                            id: '4',
                            title: '–ò–∑—É—á–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é',
                            description: '–ü–æ —Å—Ç–∞—Ç—å–µ –Ω–∞ –•–∞–±—Ä–µ',
                            tensor: [0.9, 0, 0.8, 0.4, 90],
                            context: 'home',
                            createdAt: new Date(),
                            completed: false,
                            priority: false,
                            deadline: null,
                            completedAt: null
                        },
                        {
                            id: '5',
                            title: '–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–µ–ª–∏',
                            description: '–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç',
                            tensor: [0.3, 1, 0.3, 0.9, 45],
                            context: 'office',
                            createdAt: new Date(),
                            completed: false,
                            priority: false,
                            deadline: null,
                            completedAt: null
                        }
                    ];
                },
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                initializeDefaultMask() {
                    this.currentMask = {
                        energy: 0.0, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è = 0 (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ)
                        context: Array.from({length: 4}, (_, i) => i),
                        value: 0.0, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å = 0 (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ)
                        time: 0.0, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ä–æ—á–Ω–æ—Å—Ç—å = 0 (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ)
                        duration: 480 // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                    };
                },
                
                // –ì–µ—Ç—Ç–µ—Ä—ã
                get visibleTasks() {
                    if (!this.activeFilters.filteredTasks) return this.tasks;
                    return this.tasks.filter(task => 
                        this.activeFilters.filteredTasks.includes(task.id)
                    );
                },
                
                get sortedAndFilteredTasks() {
                    let tasks = this.visibleTasks;
                    
                    // –ü–æ–∏—Å–∫
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        tasks = tasks.filter(task => 
                            task.title.toLowerCase().includes(query) ||
                            task.description.toLowerCase().includes(query)
                        );
                    }
                    
                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                    tasks = [...tasks].sort((a, b) => {
                        switch(this.sortBy) {
                            case 'priority':
                                if (a.priority !== b.priority) return b.priority - a.priority;
                                return this.calculatePriority(b) - this.calculatePriority(a);
                            case 'urgency':
                                return b.tensor[3] - a.tensor[3];
                            case 'value':
                                return b.tensor[2] - a.tensor[2];
                            case 'energy':
                                return b.tensor[0] - a.tensor[0];
                            case 'duration':
                                return a.tensor[4] - b.tensor[4];
                            case 'created':
                                return new Date(b.createdAt) - new Date(a.createdAt);
                            default:
                                return 0;
                        }
                    });
                    
                    return tasks;
                },
                
                get selectedTask() {
                    return this.tasks.find(t => t.id === this.selectedTaskId);
                },
                
                get completedTasksCount() {
                    return this.tasks.filter(t => t.completed).length;
                },
                
                get completionPercentage() {
                    if (this.tasks.length === 0) return 0;
                    return Math.round((this.completedTasksCount / this.tasks.length) * 100);
                },
                
                get highPriorityTasksCount() {
                    return this.tasks.filter(t => t.priority && !t.completed).length;
                },
                
                calculatePriority(task) {
                    // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ü–µ–Ω–Ω–æ—Å—Ç—å * —Å—Ä–æ—á–Ω–æ—Å—Ç—å * —ç–Ω–µ—Ä–≥–∏—è
                    let priority = task.tensor[2] * task.tensor[3] * task.tensor[0];
                    
                    // –£—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–¥–ª–∞–π–Ω
                    if (task.deadline) {
                        const now = new Date();
                        const deadline = new Date(task.deadline);
                        const daysUntilDeadline = (deadline - now) / (1000 * 60 * 60 * 24);
                        
                        if (daysUntilDeadline < 0) {
                            // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                            priority += 0.5;
                        } else if (daysUntilDeadline < 1) {
                            // –°–µ–≥–æ–¥–Ω—è - –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                            priority += 0.4;
                        } else if (daysUntilDeadline < 3) {
                            // –í –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ - –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                            priority += 0.2;
                        }
                    }
                    
                    return Math.min(1, priority);
                },
                
                // –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–¥–∞—á–∞–º–∏
                createTask(template = null) {
                    const newTask = template ? {
                        ...template,
                        id: Date.now().toString(),
                        createdAt: new Date(),
                        completed: false,
                        completedAt: null
                    } : {
                        id: Date.now().toString(),
                        title: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
                        description: '',
                        tensor: [0.5, 0, 0.5, 0.5, 30],
                        context: 'any',
                        createdAt: new Date(),
                        completed: false,
                        priority: false,
                        deadline: null,
                        completedAt: null
                    };
                    this.tasks.push(newTask);
                    this.selectedTaskId = newTask.id;
                    this.applyFilters();
                    this.showToast('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"', 'info', 'fa-info-circle');
                },
                
                duplicateTask(taskId) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    
                    const duplicated = {
                        ...task,
                        id: Date.now().toString(),
                        title: task.title + ' (–∫–æ–ø–∏—è)',
                        createdAt: new Date(),
                        completed: false,
                        priority: false,
                        completedAt: null
                    };
                    this.tasks.push(duplicated);
                    this.selectedTaskId = duplicated.id;
                    this.applyFilters();
                    this.showToast('–ó–∞–¥–∞—á–∞ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∞', 'success', 'fa-copy');
                },
                
                saveAsTemplate(taskId) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    
                    const template = {
                        id: Date.now().toString(),
                        title: task.title,
                        description: task.description,
                        tensor: [...task.tensor],
                        context: task.context,
                        deadline: task.deadline ? new Date(task.deadline) : null
                    };
                    
                    this.taskTemplates.push(template);
                    this.saveToStorage();
                    this.showToast('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success', 'fa-save');
                },
                
                saveTask() {
                    if (!this.selectedTask) return;
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
                    if (!this.selectedTask.title || this.selectedTask.title.trim() === '') {
                        this.showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º completedAt –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
                    if (this.selectedTask.completed && !this.selectedTask.completedAt) {
                        this.selectedTask.completedAt = new Date();
                    } else if (!this.selectedTask.completed && this.selectedTask.completedAt) {
                        this.selectedTask.completedAt = null;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É (–æ–Ω–∞ —É–∂–µ –≤ –º–∞—Å—Å–∏–≤–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ x-model)
                    this.applyFilters();
                    this.saveToStorage();
                    this.showToast('–ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success', 'fa-check');
                },
                
                deleteTask(taskId) {
                    const index = this.tasks.findIndex(t => t.id === taskId);
                    if (index !== -1) {
                        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                            this.tasks.splice(index, 1);
                            if (this.selectedTaskId === taskId) {
                                this.selectedTaskId = null;
                            }
                            this.applyFilters();
                            this.showToast('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'info', 'fa-trash');
                        }
                    }
                },
                
                autoPrioritize() {
                    if (this.tasks.length === 0) return;
                    
                    tf.engine().startScope();
                    
                    try {
                        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
                        this.tasks.forEach(task => {
                            const priority = this.calculatePriority(task);
                            task.priority = priority > 0.5;
                        });
                        
                        this.showToast('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success', 'fa-star');
                        this.applyFilters();
                    } finally {
                        tf.engine().endScope();
                    }
                },
                
                updateTaskTensor(taskId, axisIndex, value) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (task) {
                        task.tensor[axisIndex] = parseFloat(value);
                        
                        if (axisIndex === 1) {
                            const contexts = ['home', 'office', 'mobile', 'any'];
                            task.context = contexts[Math.floor(value)];
                        }
                        
                        this.applyFilters();
                        this.saveToStorage();
                    }
                },
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞
                saveToStorage() {
                    try {
                        localStorage.setItem('tensorTasks', JSON.stringify(this.tasks));
                        localStorage.setItem('tensorUserContext', JSON.stringify(this.userContext));
                        localStorage.setItem('tensorViewMode', this.viewMode);
                        localStorage.setItem('tensorCurrentMask', JSON.stringify(this.currentMask));
                        localStorage.setItem('tensorTaskTemplates', JSON.stringify(this.taskTemplates));
                    } catch (e) {
                        this.handleError(e, 'saveToStorage');
                    }
                },
                
                loadFromStorage() {
                    try {
                        const savedTasks = localStorage.getItem('tensorTasks');
                        if (savedTasks) {
                            const tasks = JSON.parse(savedTasks);
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                            tasks.forEach(task => {
                                task.createdAt = new Date(task.createdAt);
                                if (!task.priority) task.priority = false;
                                if (task.deadline) task.deadline = new Date(task.deadline);
                                if (!task.hasOwnProperty('deadline')) task.deadline = null;
                                if (!task.hasOwnProperty('completedAt')) task.completedAt = null;
                            });
                            this.tasks = tasks;
                        }
                        
                        const savedContext = localStorage.getItem('tensorUserContext');
                        if (savedContext) {
                            this.userContext = JSON.parse(savedContext);
                        }
                        
                        const savedViewMode = localStorage.getItem('tensorViewMode');
                        if (savedViewMode) {
                            this.viewMode = savedViewMode;
                        }
                        
                        const savedMask = localStorage.getItem('tensorCurrentMask');
                        if (savedMask) {
                            this.currentMask = JSON.parse(savedMask);
                        }
                        
                        const savedTemplates = localStorage.getItem('tensorTaskTemplates');
                        if (savedTemplates) {
                            this.taskTemplates = JSON.parse(savedTemplates);
                        }
                    } catch (e) {
                        this.handleError(e, 'loadFromStorage');
                    }
                },
                
                // –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
                exportData(format = 'json') {
                    try {
                        let blob, filename, mimeType;
                        
                        switch(format) {
                            case 'json':
                                const data = {
                                    tasks: this.tasks,
                                    userContext: this.userContext,
                                    currentMask: this.currentMask,
                                    exportDate: new Date().toISOString()
                                };
                                blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                filename = `tensor-tasks-${new Date().toISOString().split('T')[0]}.json`;
                                break;
                                
                            case 'csv':
                                const csvHeaders = ['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ', '–≠–Ω–µ—Ä–≥–∏—è', '–ö–æ–Ω—Ç–µ–∫—Å—Ç', '–¶–µ–Ω–Ω–æ—Å—Ç—å', '–°—Ä–æ—á–Ω–æ—Å—Ç—å', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–î–µ–¥–ª–∞–π–Ω', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–°–æ–∑–¥–∞–Ω–æ'];
                                const csvRows = this.tasks.map(task => [
                                    task.id,
                                    `"${(task.title || '').replace(/"/g, '""')}"`,
                                    `"${(task.description || '').replace(/"/g, '""')}"`,
                                    task.tensor[0],
                                    task.context,
                                    task.tensor[2],
                                    task.tensor[3],
                                    task.tensor[4],
                                    task.deadline ? new Date(task.deadline).toISOString() : '',
                                    task.completed ? '–î–∞' : '–ù–µ—Ç',
                                    task.priority ? '–î–∞' : '–ù–µ—Ç',
                                    new Date(task.createdAt).toISOString()
                                ]);
                                const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                                blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                                filename = `tensor-tasks-${new Date().toISOString().split('T')[0]}.csv`;
                                break;
                                
                            case 'ical':
                                const icalEvents = this.tasks
                                    .filter(task => task.deadline)
                                    .map(task => {
                                        const deadline = new Date(task.deadline);
                                        const endDate = new Date(deadline);
                                        endDate.setHours(endDate.getHours() + 1);
                                        return [
                                            'BEGIN:VEVENT',
                                            `UID:${task.id}@tensortask`,
                                            `DTSTART:${this.formatICalDate(deadline)}`,
                                            `DTEND:${this.formatICalDate(endDate)}`,
                                            `SUMMARY:${task.title.replace(/[,;\\]/g, '')}`,
                                            `DESCRIPTION:${task.description.replace(/[,;\\]/g, '')}`,
                                            task.completed ? 'STATUS:COMPLETED' : 'STATUS:CONFIRMED',
                                            'END:VEVENT'
                                        ].join('\r\n');
                                    });
                                const icalContent = [
                                    'BEGIN:VCALENDAR',
                                    'VERSION:2.0',
                                    'PRODID:-//TensorTask Manager//EN',
                                    'CALSCALE:GREGORIAN',
                                    ...icalEvents,
                                    'END:VCALENDAR'
                                ].join('\r\n');
                                blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
                                filename = `tensor-tasks-${new Date().toISOString().split('T')[0]}.ics`;
                                break;
                                
                            case 'markdown':
                                const mdContent = [
                                    '# TensorTask Manager - –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á',
                                    `\n–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}\n`,
                                    `–í—Å–µ–≥–æ –∑–∞–¥–∞—á: ${this.tasks.length}`,
                                    `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${this.completedTasksCount}\n`,
                                    '---\n',
                                    ...this.tasks.map((task, index) => [
                                        `## ${index + 1}. ${task.title}`,
                                        task.description ? `\n${task.description}\n` : '',
                                        `- **–°—Ç–∞—Ç—É—Å:** ${task.completed ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}`,
                                        task.priority ? '- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚≠ê –í—ã—Å–æ–∫–∏–π' : '',
                                        task.deadline ? `- **–î–µ–¥–ª–∞–π–Ω:** ${new Date(task.deadline).toLocaleDateString('ru-RU')}` : '',
                                        `- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** ${CONTEXT_LABELS[task.context]?.label || task.context}`,
                                        `- **–≠–Ω–µ—Ä–≥–∏—è:** ${Math.round(task.tensor[0] * 100)}%`,
                                        `- **–¶–µ–Ω–Ω–æ—Å—Ç—å:** ${Math.round(task.tensor[2] * 100)}%`,
                                        `- **–°—Ä–æ—á–Ω–æ—Å—Ç—å:** ${Math.round(task.tensor[3] * 100)}%`,
                                        `- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ${task.tensor[4]} –º–∏–Ω`,
                                        `- **–°–æ–∑–¥–∞–Ω–æ:** ${new Date(task.createdAt).toLocaleString('ru-RU')}`,
                                        ''
                                    ].filter(Boolean).join('\n'))
                                ].join('\n');
                                blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8' });
                                filename = `tensor-tasks-${new Date().toISOString().split('T')[0]}.md`;
                                break;
                                
                            default:
                                throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞: ${format}`);
                        }
                        
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        this.showToast(`–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ ${format.toUpperCase()}`, 'success', 'fa-download');
                    } catch (e) {
                        this.handleError(e, 'exportData');
                        this.showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ', 'error', 'fa-exclamation-triangle');
                    }
                },
                
                formatICalDate(date) {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                },
                
                importDataFromJSON() {
                    try {
                        const data = JSON.parse(this.importData);
                        
                        if (data.tasks && Array.isArray(data.tasks)) {
                            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                            const validTasks = [];
                            data.tasks.forEach((task, index) => {
                                try {
                                    if (!task.id || !task.title) {
                                        throw new Error(`–ó–∞–¥–∞—á–∞ ${index + 1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç id –∏–ª–∏ title`);
                                    }
                                    if (!Array.isArray(task.tensor) || task.tensor.length !== 5) {
                                        throw new Error(`–ó–∞–¥–∞—á–∞ ${index + 1}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–Ω–∑–æ—Ä–∞`);
                                    }
                                    task.createdAt = new Date(task.createdAt || new Date());
                                    if (!task.priority) task.priority = false;
                                    if (task.deadline) task.deadline = new Date(task.deadline);
                                    if (!task.hasOwnProperty('deadline')) task.deadline = null;
                                    if (!task.hasOwnProperty('completedAt')) task.completedAt = null;
                                    validTasks.push(task);
                                } catch (e) {
                                    console.warn(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ ${index + 1}:`, e.message);
                                }
                            });
                            
                            if (validTasks.length === 0) {
                                throw new Error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                            }
                            
                            this.tasks = validTasks;
                            if (validTasks.length < data.tasks.length) {
                                this.showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${validTasks.length} –∏–∑ ${data.tasks.length} –∑–∞–¥–∞—á`, 'warning', 'fa-exclamation-triangle');
                            }
                        }
                        
                        if (data.userContext) {
                            this.userContext = data.userContext;
                        }
                        
                        if (data.currentMask) {
                            this.currentMask = data.currentMask;
                        }
                        
                        if (data.taskTemplates && Array.isArray(data.taskTemplates)) {
                            this.taskTemplates = data.taskTemplates;
                        }
                        
                        this.showImportDialog = false;
                        this.importData = '';
                        this.applyFilters();
                        this.showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success', 'fa-upload');
                    } catch (e) {
                        this.handleError(e, 'importDataFromJSON');
                        this.showToast(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${e.message}`, 'error', 'fa-exclamation-triangle');
                    }
                },
                
                // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                showToast(message, type = 'info', icon = 'fa-info-circle') {
                    const toast = {
                        message,
                        type,
                        icon: 'fas ' + icon,
                        visible: true
                    };
                    
                    this.toasts.push(toast);
                    
                    setTimeout(() => {
                        this.removeToast(this.toasts.indexOf(toast));
                    }, 3000);
                },
                
                removeToast(index) {
                    if (index >= 0 && index < this.toasts.length) {
                        this.toasts[index].visible = false;
                        setTimeout(() => {
                            this.toasts.splice(index, 1);
                        }, 300);
                    }
                },
                
                // –£—Ç–∏–ª–∏—Ç—ã
                formatDate(date) {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                getTaskTitle(taskId) {
                    const task = this.tasks.find(t => t.id === taskId);
                    return task ? task.title : `–ó–∞–¥–∞—á–∞ ${taskId}`;
                },
                
                // TensorFlow.js –æ–ø–µ—Ä–∞—Ü–∏–∏
                async applyFilters() {
                    // Debounce: –æ—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤
                    if (this.filterDebounceTimer) {
                        clearTimeout(this.filterDebounceTimer);
                        this.filterDebounceTimer = null;
                    }
                    
                    // –ï—Å–ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–ª–∞–Ω–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    if (this.isApplyingFilters) {
                        this.filterDebounceTimer = setTimeout(() => this.applyFilters(), 150);
                        return;
                    }
                    
                    if (this.tasks.length === 0) {
                        this.activeFilters.filteredTasks = [];
                        this.activeFilters.clusters = {};
                        return;
                    }
                    
                    this.isApplyingFilters = true;
                    this.isLoading = true;
                    
                    try {
                        await this._applyFiltersInternal();
                    } catch (e) {
                        this.handleError(e, 'applyFilters');
                        this.activeFilters.filteredTasks = this.tasks.map(t => t.id);
                        this.activeFilters.clusters = {};
                    } finally {
                        this.isApplyingFilters = false;
                        this.isLoading = false;
                        // –ï—Å–ª–∏ –±—ã–ª –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤, –≤—ã–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
                        if (this.filterDebounceTimer) {
                            const timer = this.filterDebounceTimer;
                            this.filterDebounceTimer = null;
                            clearTimeout(timer);
                            setTimeout(() => this.applyFilters(), 50);
                        }
                    }
                },
                
                async _applyFiltersInternal() {
                    if (this.tasks.length === 0) {
                        this.activeFilters.filteredTasks = [];
                        this.activeFilters.clusters = {};
                        return;
                    }
                    
                    try {
                        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ—Ä–æ–≥–∞–º: –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –≤—Å–µ –µ—ë –∑–Ω–∞—á–µ–Ω–∏—è >= –ø–æ—Ä–æ–≥–æ–≤
                        const thresholds = {
                            energy: this.currentMask.energy,      // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è
                            value: this.currentMask.value,       // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å
                            time: this.currentMask.time,         // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ä–æ—á–Ω–æ—Å—Ç—å
                            duration: this.currentMask.duration   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        };
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
                        const allowedContexts = Array.isArray(this.currentMask.context) 
                            ? this.currentMask.context 
                            : [0, 1, 2, 3];
                        
                        const filteredTasks = this.tasks.filter((task) => {
                            const tensor = task.tensor;
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                            const taskContext = Math.floor(tensor[1]);
                            if (!allowedContexts.includes(taskContext)) {
                                return false;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ (—ç–Ω–µ—Ä–≥–∏—è, —Ü–µ–Ω–Ω–æ—Å—Ç—å, —Å—Ä–æ—á–Ω–æ—Å—Ç—å)
                            if (tensor[0] < thresholds.energy) return false; // –≠–Ω–µ—Ä–≥–∏—è
                            if (tensor[2] < thresholds.value) return false; // –¶–µ–Ω–Ω–æ—Å—Ç—å
                            if (tensor[3] < thresholds.time) return false; // –°—Ä–æ—á–Ω–æ—Å—Ç—å
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è)
                            if (tensor[4] > thresholds.duration) return false; // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                            
                            return true;
                        });
                        
                        // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–æ—Ç—è –±—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—á–∏
                        if (filteredTasks.length === 0) {
                            this.activeFilters.filteredTasks = this.tasks.map(t => t.id);
                        } else {
                            this.activeFilters.filteredTasks = filteredTasks.map(t => t.id);
                        }
                        
                        // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                        const contextArray = this.tasks.map(task => [task.tensor[1]]);
                        this.updateClusteringFromArray(contextArray);
                        
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –≤ _applyFiltersInternal:', e);
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
                        this.activeFilters.filteredTasks = this.tasks.map(t => t.id);
                        this.activeFilters.clusters = {};
                    }
                },
                
                updateClusteringFromArray(contextArray) {
                    if (!contextArray || !Array.isArray(contextArray) || contextArray.length === 0) {
                        this.activeFilters.clusters = {};
                        return;
                    }
                    
                    const clusters = {};
                    this.tasks.forEach((task, index) => {
                        if (index < contextArray.length && contextArray[index] && Array.isArray(contextArray[index]) && contextArray[index].length > 0) {
                            const ctxValue = Math.floor(contextArray[index][0]);
                            if (!isNaN(ctxValue)) {
                                if (!clusters[ctxValue]) clusters[ctxValue] = [];
                                clusters[ctxValue].push(task.id);
                            }
                        }
                    });
                    
                    this.activeFilters.clusters = clusters;
                },
                
                async applyContextSlicing(userContext) {
                    this.currentMask = {
                        energy: userContext.energy,
                        context: this.getContextMask(userContext.location),
                        value: 0.3,
                        time: userContext.availableTime / 480,
                        duration: 480
                    };
                    
                    await this.applyFilters();
                },
                
                getContextMask(location) {
                    const contextMap = {
                        'home': [0],
                        'office': [1],
                        'mobile': [2],
                        'any': [0, 1, 2, 3]
                    };
                    return contextMap[location] || [0, 1, 2, 3];
                },
                
                async batchSimilarTasks() {
                    if (this.tasks.length < 2) {
                        this.showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–¥–∞—á –¥–ª—è –±–∞—Ç—á–∏–Ω–≥–∞', 'warning', 'fa-exclamation');
                        return;
                    }
                    
                    this.isLoading = true;
                    tf.engine().startScope();
                    
                    try {
                        const taskData = this.tasks.map(task => task.tensor);
                        const tasksTensor = tf.tensor2d(taskData);
                        
                        const normalized = tasksTensor.div(tf.norm(tasksTensor, 'euclidean', 1, true));
                        const similarity = tf.matMul(normalized, normalized.transpose());
                        
                        const similarityArray = await similarity.array();
                        const batches = [];
                        const used = new Set();
                        
                        for (let i = 0; i < similarityArray.length; i++) {
                            if (used.has(i)) continue;
                            
                            const batchTaskIds = [this.tasks[i].id];
                            const batchSimilarities = [];
                            used.add(i);
                            
                            for (let j = i + 1; j < similarityArray.length; j++) {
                                if (!used.has(j) && similarityArray[i][j] > 0.8) {
                                    batchTaskIds.push(this.tasks[j].id);
                                    batchSimilarities.push(similarityArray[i][j]);
                                    used.add(j);
                                }
                            }
                            
                            if (batchTaskIds.length > 1) {
                                // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –±–∞—Ç—á–∞
                                const batchTasks = batchTaskIds.map(id => this.tasks.find(t => t.id === id)).filter(Boolean);
                                const totalDuration = batchTasks.reduce((sum, task) => sum + task.tensor[4], 0);
                                const individualDuration = batchTasks.reduce((sum, task) => sum + task.tensor[4], 0);
                                // –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ 5 –º–∏–Ω—É—Ç –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
                                const contextSwitches = batchTasks.length - 1;
                                const timeSaved = contextSwitches * 5;
                                const avgSimilarity = batchSimilarities.length > 0 
                                    ? batchSimilarities.reduce((a, b) => a + b, 0) / batchSimilarities.length 
                                    : similarityArray[i][i];
                                
                                batches.push({
                                    taskIds: batchTaskIds,
                                    totalDuration: totalDuration,
                                    timeSaved: timeSaved,
                                    similarity: avgSimilarity,
                                    taskCount: batchTaskIds.length
                                });
                            }
                        }
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞—Ç—á–∏ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                        batches.sort((a, b) => b.timeSaved - a.timeSaved);
                        
                        this.activeFilters.batches = batches;
                        this.showToast(`–ù–∞–π–¥–µ–Ω–æ ${batches.length} –±–∞—Ç—á–µ–π`, 'success', 'fa-layer-group');
                        
                    } catch (e) {
                        this.handleError(e, 'batchSimilarTasks');
                        this.showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞—Ç—á–∏–Ω–≥–µ', 'error', 'fa-exclamation-triangle');
                    } finally {
                        tf.engine().endScope();
                        this.isLoading = false;
                    }
                },
                
                executeBatch(batchIndex) {
                    const batch = this.activeFilters.batches[batchIndex];
                    if (!batch) return;
                    
                    batch.taskIds.forEach(taskId => {
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task && !task.completed) {
                            task.completed = true;
                            task.completedAt = new Date();
                        }
                    });
                    
                    this.applyFilters();
                    this.saveToStorage();
                    this.showToast(`–ë–∞—Ç—á ${batchIndex + 1} –≤—ã–ø–æ–ª–Ω–µ–Ω`, 'success', 'fa-check');
                },
                
                async probabilisticPlanning() {
                    this.isLoading = true;
                    this.loadingProgress = 0;
                    
                    const timeDistributions = this.tasks.map(task => {
                        const duration = task.tensor[4];
                        return {
                            mean: duration,
                            std: duration * 0.3,
                            taskId: task.id
                        };
                    });
                    
                    const simulations = 100;
                    let totalTime = 0;
                    
                    for (let i = 0; i < simulations; i++) {
                        let simTime = 0;
                        for (const dist of timeDistributions) {
                            const sample = dist.mean + (Math.random() - 0.5) * 2 * dist.std;
                            simTime += Math.max(5, sample);
                        }
                        totalTime += simTime;
                        this.loadingProgress = Math.round((i + 1) / simulations * 100);
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    
                    const avgTime = totalTime / simulations;
                    this.probabilisticStats = {
                        avgCompletionTime: avgTime,
                        confidence: Math.min(0.95, 1 - (avgTime * 0.001))
                    };
                    
                    this.isLoading = false;
                    this.loadingProgress = 0;
                },
                
                // Three.js –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                async initThreeJS() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ 3D —Ä–µ–∂–∏–º–µ
                    if (this.viewMode !== '3d') return;
                    
                    const threeContainer = document.getElementById('three-container');
                    if (!threeContainer) {
                        console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä three-container –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    
                    // –ï—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    if (threeJSStore.scene) {
                        this.updateTaskVisualization();
                        return;
                    }
                    
                    const container = document.createElement('div');
                    container.className = 'three-canvas';
                    threeContainer.appendChild(container);
                    threeJSStore.container = container;
                    
                    threeJSStore.scene = new THREE.Scene();
                    threeJSStore.camera = new THREE.PerspectiveCamera(75, threeContainer.clientWidth / threeContainer.clientHeight, 0.1, 1000);
                    threeJSStore.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                    
                    threeJSStore.renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
                    container.appendChild(threeJSStore.renderer.domElement);
                    
                    threeJSStore.camera.position.set(4, 4, 4);
                    threeJSStore.camera.lookAt(0, 0, 0);
                    
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    threeJSStore.scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    threeJSStore.scene.add(directionalLight);
                    
                    this.createAxes();
                    
                    threeJSStore.taskPoints = new THREE.Group();
                    threeJSStore.scene.add(threeJSStore.taskPoints);
                    
                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
                    this.setupCameraControls(threeContainer);
                    
                    this.animate();
                    
                    window.addEventListener('resize', () => this.onWindowResize());
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    this.updateTaskVisualization();
                },
                
                setupCameraControls(container) {
                    let isDragging = false;
                    let previousMousePosition = { x: 0, y: 0 };
                    let cameraDistance = 5;
                    let cameraAngleX = Math.PI / 4;
                    let cameraAngleY = Math.PI / 4;
                    
                    // Touch –ø–æ–¥–¥–µ—Ä–∂–∫–∞
                    let touchStartDistance = 0;
                    let touchStartAngleX = cameraAngleX;
                    let touchStartAngleY = cameraAngleY;
                    
                    const updateCameraPosition = () => {
                        if (!threeJSStore.camera) return;
                        threeJSStore.camera.position.x = cameraDistance * Math.sin(cameraAngleY) * Math.cos(cameraAngleX);
                        threeJSStore.camera.position.y = cameraDistance * Math.sin(cameraAngleX);
                        threeJSStore.camera.position.z = cameraDistance * Math.cos(cameraAngleY) * Math.cos(cameraAngleX);
                        threeJSStore.camera.lookAt(0, 0, 0);
                    };
                    
                    // Mouse —Å–æ–±—ã—Ç–∏—è
                    container.addEventListener('mousedown', (e) => {
                        if (e.button === 2 || (e.button === 0 && e.ctrlKey)) { // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –∏–ª–∏ Ctrl+–õ–ö–ú
                            isDragging = true;
                            previousMousePosition = { x: e.clientX, y: e.clientY };
                            e.preventDefault();
                        }
                    });
                    
                    container.addEventListener('mousemove', (e) => {
                        if (isDragging) {
                            const deltaX = e.clientX - previousMousePosition.x;
                            const deltaY = e.clientY - previousMousePosition.y;
                            
                            cameraAngleY -= deltaX * 0.01;
                            cameraAngleX += deltaY * 0.01;
                            cameraAngleX = Math.max(0.1, Math.min(Math.PI - 0.1, cameraAngleX));
                            
                            updateCameraPosition();
                            previousMousePosition = { x: e.clientX, y: e.clientY };
                        }
                    });
                    
                    container.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                    
                    container.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                    });
                    
                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
                    container.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const delta = e.deltaY * 0.01;
                        cameraDistance = Math.max(2, Math.min(10, cameraDistance + delta));
                        updateCameraPosition();
                    });
                    
                    // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    container.addEventListener('touchstart', (e) => {
                        if (e.touches.length === 1) {
                            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                            isDragging = true;
                        } else if (e.touches.length === 2) {
                            const dx = e.touches[0].clientX - e.touches[1].clientX;
                            const dy = e.touches[0].clientY - e.touches[1].clientY;
                            touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                            touchStartAngleX = cameraAngleX;
                            touchStartAngleY = cameraAngleY;
                        }
                    });
                    
                    container.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (e.touches.length === 1 && isDragging) {
                            const deltaX = e.touches[0].clientX - previousMousePosition.x;
                            const deltaY = e.touches[0].clientY - previousMousePosition.y;
                            
                            cameraAngleY -= deltaX * 0.01;
                            cameraAngleX += deltaY * 0.01;
                            cameraAngleX = Math.max(0.1, Math.min(Math.PI - 0.1, cameraAngleX));
                            
                            updateCameraPosition();
                            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        } else if (e.touches.length === 2) {
                            const dx = e.touches[0].clientX - e.touches[1].clientX;
                            const dy = e.touches[0].clientY - e.touches[1].clientY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const scale = distance / touchStartDistance;
                            cameraDistance = Math.max(2, Math.min(10, cameraDistance / scale));
                            touchStartDistance = distance;
                            updateCameraPosition();
                        }
                    });
                    
                    container.addEventListener('touchend', () => {
                        isDragging = false;
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á
                    let clickStartTime = 0;
                    container.addEventListener('mousedown', (e) => {
                        if (e.button === 0 && !e.ctrlKey) {
                            clickStartTime = Date.now();
                        }
                    });
                    
                    container.addEventListener('click', (event) => {
                        if (isDragging || (Date.now() - clickStartTime) > 200) return;
                        if (event.ctrlKey) return;
                        
                        const mouse = new THREE.Vector2();
                        const rect = container.getBoundingClientRect();
                        
                        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                        
                        const raycaster = new THREE.Raycaster();
                        if (!threeJSStore.camera || !threeJSStore.taskPoints) return;
                        raycaster.setFromCamera(mouse, threeJSStore.camera);
                        
                        const intersects = raycaster.intersectObjects(threeJSStore.taskPoints.children, true);
                        
                        if (intersects.length > 0) {
                            const taskId = intersects[0].object.userData.taskId;
                            this.selectedTaskId = taskId;
                            this.showToast('–ó–∞–¥–∞—á–∞ –≤—ã–±—Ä–∞–Ω–∞', 'info', 'fa-hand-pointer');
                        }
                    });
                },
                
                createAxes() {
                    if (!threeJSStore.scene) return;
                    const axesHelper = new THREE.AxesHelper(2);
                    threeJSStore.scene.add(axesHelper);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç–∫—É –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                    const gridHelper = new THREE.GridHelper(4, 10, 0x444444, 0x222222);
                    threeJSStore.scene.add(gridHelper);
                },
                
                updateTaskVisualization() {
                    if (!threeJSStore.taskPoints || this.viewMode !== '3d') return;
                    
                    const visibleTaskIds = new Set(this.visibleTasks.map(t => t.id));
                    const currentTaskIds = new Set(Array.from(threeJSStore.taskObjectsMap.keys()));
                    
                    // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –Ω–µ–≤–∏–¥–∏–º—ã—Ö –∑–∞–¥–∞—á
                    const toRemove = [];
                    currentTaskIds.forEach(taskId => {
                        if (!visibleTaskIds.has(taskId)) {
                            const obj = threeJSStore.taskObjectsMap.get(taskId);
                            if (obj) {
                                threeJSStore.taskPoints.remove(obj);
                                threeJSStore.taskObjectsMap.delete(taskId);
                                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø—É–ª (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
                                if (obj.geometry) obj.geometry.dispose();
                                if (obj.material) {
                                    if (Array.isArray(obj.material)) {
                                        obj.material.forEach(m => m.dispose());
                                    } else {
                                        obj.material.dispose();
                                    }
                                }
                            }
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –≤–∏–¥–∏–º—ã—Ö –∑–∞–¥–∞—á
                    this.visibleTasks.forEach(task => {
                        const [energy, context, value, urgency, duration] = task.tensor;
                        
                        const x = energy * 2 - 1;
                        const y = (context / 3) * 2 - 1;
                        const z = value * 2 - 1;
                        
                        const colors = {
                            'home': 0x4ECDC4,
                            'office': 0x118AB2,
                            'mobile': 0xFFD166,
                            'any': 0x8A8D8F
                        };
                        
                        let color = colors[task.context] || 0xffffff;
                        
                        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ - –∑–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç
                        if (task.priority) {
                            color = 0xFFD700;
                        }
                        
                        const baseSize = 0.1 + value * 0.1;
                        const size = task.priority ? baseSize * 1.3 : baseSize;
                        
                        let sphere = threeJSStore.taskObjectsMap.get(task.id);
                        const taskChanged = !sphere || 
                            sphere.position.x !== x || 
                            sphere.position.y !== y || 
                            sphere.position.z !== z ||
                            (sphere.userData.task?.priority !== task.priority) ||
                            (sphere.userData.task?.completed !== task.completed);
                        
                        if (!sphere) {
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
                            const geometry = new THREE.SphereGeometry(size, 16, 16);
                            const material = new THREE.MeshPhongMaterial({ 
                                color: color,
                                transparent: true,
                                opacity: task.completed ? 0.3 : 0.8,
                                emissive: task.priority ? 0x332200 : 0x000000,
                                emissiveIntensity: task.priority ? 0.3 : 0
                            });
                            
                            sphere = new THREE.Mesh(geometry, material);
                            sphere.position.set(x, y, z);
                            sphere.userData = { taskId: task.id, task: task };
                            
                            threeJSStore.taskPoints.add(sphere);
                            threeJSStore.taskObjectsMap.set(task.id, sphere);
                        } else if (taskChanged) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç
                            sphere.position.set(x, y, z);
                            sphere.userData.task = task;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª
                            if (sphere.material) {
                                sphere.material.color.setHex(color);
                                sphere.material.opacity = task.completed ? 0.3 : 0.8;
                                sphere.material.emissive.setHex(task.priority ? 0x332200 : 0x000000);
                                sphere.material.emissiveIntensity = task.priority ? 0.3 : 0;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
                            if (sphere.geometry) {
                                sphere.geometry.dispose();
                                sphere.geometry = new THREE.SphereGeometry(size, 16, 16);
                            }
                        }
                        
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (glow, star)
                        while (sphere.children.length > 0) {
                            const child = sphere.children[0];
                            sphere.remove(child);
                            if (child.geometry) child.geometry.dispose();
                            if (child.material) child.material.dispose();
                        }
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
                        if (task.id === this.selectedTaskId) {
                            const glowGeometry = new THREE.SphereGeometry(size * 1.5, 32, 32);
                            const glowMaterial = new THREE.MeshBasicMaterial({
                                color: 0xffffff,
                                transparent: true,
                                opacity: 0.4
                            });
                            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                            sphere.add(glow);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–µ—Ç–∫—É –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á
                        if (task.priority && !task.completed) {
                            const starGeometry = new THREE.ConeGeometry(0.05, 0.1, 3);
                            const starMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
                            const star = new THREE.Mesh(starGeometry, starMaterial);
                            star.position.set(0, size + 0.15, 0);
                            sphere.add(star);
                        }
                    });
                },
                
                cleanupUnusedObjects() {
                    // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑ –ø—É–ª–∞
                    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –ø—É–ª –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
                    threeJSStore.objectPool = [];
                },
                
                animate() {
                    requestAnimationFrame(() => this.animate());
                    
                    if (threeJSStore.taskPoints && threeJSStore.isAnimating) {
                        threeJSStore.taskPoints.rotation.y += 0.001;
                    }
                    
                    if (threeJSStore.renderer && threeJSStore.scene && threeJSStore.camera) {
                        threeJSStore.renderer.render(threeJSStore.scene, threeJSStore.camera);
                    }
                },
                
                onWindowResize() {
                    if (threeJSStore.camera && threeJSStore.renderer) {
                        const threeContainer = document.getElementById('three-container');
                        if (threeContainer) {
                            const width = threeContainer.clientWidth;
                            const height = threeContainer.clientHeight;
                            threeJSStore.camera.aspect = width / height;
                            threeJSStore.camera.updateProjectionMatrix();
                            threeJSStore.renderer.setSize(width, height);
                        }
                    }
                },
                
                // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                            if (e.key === 'Escape') {
                                e.target.blur();
                                if (this.selectedTaskId) {
                                    this.selectedTaskId = null;
                                }
                            }
                            return;
                        }
                        
                        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                        const ctrlKey = isMac ? e.metaKey : e.ctrlKey;
                        
                        if (ctrlKey && e.key === 'n') {
                            e.preventDefault();
                            this.createTask();
                        } else if (ctrlKey && e.key === 's') {
                            e.preventDefault();
                            if (this.selectedTask) {
                                this.saveTask();
                            }
                        } else if (ctrlKey && e.key === 'f') {
                            e.preventDefault();
                            const searchInput = document.querySelector('input[placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..."]');
                            if (searchInput) searchInput.focus();
                        } else if (ctrlKey && e.key === 'b') {
                            e.preventDefault();
                            this.batchSimilarTasks();
                        } else if (ctrlKey && e.key === 'p') {
                            e.preventDefault();
                            this.autoPrioritize();
                        } else if (e.key === 'Delete' || e.key === 'Backspace') {
                            if (this.selectedTaskId) {
                                e.preventDefault();
                                this.deleteTask(this.selectedTaskId);
                            }
                        } else if (e.key === 'Escape') {
                            if (this.selectedTaskId) {
                                this.selectedTaskId = null;
                            }
                            if (this.showImportDialog) {
                                this.showImportDialog = false;
                            }
                        }
                    });
                },
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                handleError(error, context) {
                    const errorMessage = error instanceof Error ? error.message : String(error);
                    console.error(`[${context}]`, error);
                    console.error('Stack:', error.stack);
                    
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –æ—à–∏–±–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –±—É–¥—É—â–µ–º
                    // –∏–ª–∏ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                },
                
                // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–µ–¥–ª–∞–π–Ω–æ–≤
                getDeadlineStatus(task) {
                    if (!task.deadline) return null;
                    const now = new Date();
                    const deadline = new Date(task.deadline);
                    const daysUntilDeadline = (deadline - now) / (1000 * 60 * 60 * 24);
                    
                    if (daysUntilDeadline < 0) return { status: 'overdue', days: Math.abs(Math.floor(daysUntilDeadline)) };
                    if (daysUntilDeadline < 1) return { status: 'today', days: 0 };
                    if (daysUntilDeadline < 3) return { status: 'soon', days: Math.floor(daysUntilDeadline) };
                    return { status: 'normal', days: Math.floor(daysUntilDeadline) };
                },
                
                formatDeadline(date) {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric'
                    });
                }
            };
        }
    </script>
</body>
</html>
